<IfModule mod_rewrite.c>
  RewriteEngine On

  ###############################################################################
  # 1) LEGACY / CONTENT REDIRECTS — ABSOLUTE CANONICAL TARGETS (ONE HOP)
  # These rules MUST redirect directly to https://www.hillcopaint.com/... in 301.
  # They MUST be above origin canonicalization so they work in one hop even for
  # http://hillcopaint.com/... and https://hillcopaint.com/... and trailing slashes.
  ###############################################################################

  # --- Cities / old pages ---
  RewriteRule ^pflugerville/?$ https://www.hillcopaint.com/service-areas [R=301,L]
  RewriteRule ^georgetown/?$ https://www.hillcopaint.com/service-areas [R=301,L]
  RewriteRule ^hutto/?$ https://www.hillcopaint.com/service-areas [R=301,L]
  RewriteRule ^round-rock/?$ https://www.hillcopaint.com/service-areas [R=301,L]
  RewriteRule ^round-rock-2/?$ https://www.hillcopaint.com/service-areas [R=301,L]
  RewriteRule ^leander/?$ https://www.hillcopaint.com/service-areas [R=301,L]
  RewriteRule ^cedar-park/?$ https://www.hillcopaint.com/service-areas [R=301,L]

  # --- Old /service-areas subpaths that should collapse to hub ---
  RewriteRule ^service-areas/round-rock.*$ https://www.hillcopaint.com/service-areas [R=301,L]
  RewriteRule ^service-areas/leander.*$ https://www.hillcopaint.com/service-areas [R=301,L]
  RewriteRule ^service-areas/taylor-hutto.*$ https://www.hillcopaint.com/service-areas [R=301,L]
  RewriteRule ^service-areas/wells-branch.*$ https://www.hillcopaint.com/service-areas [R=301,L]

  # --- Broken area URL fix ---
  RewriteRule ^areas/downtown-austin-luxury/old-west-austin/?$ https://www.hillcopaint.com/areas/downtown-austin-luxury/old-west-austin-central [R=301,L]

  # --- Old commercial pattern ---
  RewriteRule ^commercial-painting-.*$ https://www.hillcopaint.com/services/commercial [R=301,L]

  # --- Old residential/commercial building patterns ---
  RewriteRule ^residential-painting.*$ https://www.hillcopaint.com/services [R=301,L]
  RewriteRule ^residential-building-painting.*$ https://www.hillcopaint.com/services [R=301,L]
  RewriteRule ^commercial-building-painting.*$ https://www.hillcopaint.com/services/commercial [R=301,L]

  # --- Old guide patterns ---
  RewriteRule ^guides/painting-costs-round-rock.*$ https://www.hillcopaint.com/guides/painting-costs-austin [R=301,L]
  RewriteRule ^guides/painting-costs-(?!austin).*$ https://www.hillcopaint.com/guides/painting-costs-austin [R=301,L]
  RewriteRule ^guides/hoa-color-tips-(?!austin).*$ https://www.hillcopaint.com/guides/hoa-color-tips-austin [R=301,L]
  RewriteRule ^guides/best-paint-texas-heat-.*$ https://www.hillcopaint.com/guides/best-paint-texas-heat [R=301,L]
  RewriteRule ^guides/how-often-paint-(?!central-texas).*$ https://www.hillcopaint.com/guides/how-often-paint-central-texas [R=301,L]

  # --- Legacy /service/* targeted routing ---
  # Must route legacy /service/* directly to the correct canonical service page.
  RewriteRule ^service/.*interior.*$ https://www.hillcopaint.com/services/interior-painting [R=301,L]
  RewriteRule ^service/.*door-painting.*$ https://www.hillcopaint.com/services/interior-painting [R=301,L]
  RewriteRule ^service/.*commercial.*$ https://www.hillcopaint.com/services/commercial [R=301,L]
  RewriteRule ^service/.*window-frame.*$ https://www.hillcopaint.com/services/commercial [R=301,L]
  RewriteRule ^service/.*cabinet.*$ https://www.hillcopaint.com/services/cabinet-refinishing [R=301,L]
  RewriteRule ^service/.*$ https://www.hillcopaint.com/services/exterior-painting [R=301,L]


  ###############################################################################
  # 2) STRIP TRACKING PARAMS (?ref=) IN ONE HOP TO CANONICAL
  # Must remove the query string entirely by using trailing '?' in the target.
  ###############################################################################
  RewriteCond %{QUERY_STRING} (^|&)ref= [NC]
  RewriteRule ^(.*)$ https://www.hillcopaint.com/$1? [R=301,L]


  ###############################################################################
  # 3) ORIGIN CANONICALIZATION IN ONE HOP (http->https AND non-www->www)
  #
  # Split into two rules so a trailing slash on a non-canonical origin is stripped
  # in the same hop — without this, http://hillcopaint.com/about/ would land on
  # https://www.hillcopaint.com/about/ (slash intact), requiring a second hop from
  # rule 4. Rule 3a strips the slash and canonicalizes in one redirect; rule 3b
  # handles paths that already have no trailing slash.
  ###############################################################################

  # 3a: non-canonical origin + trailing slash → canonical URL without slash (1 hop)
  RewriteCond %{HTTPS} off [OR]
  RewriteCond %{HTTP_HOST} !^www\.hillcopaint\.com$ [NC]
  RewriteRule ^(.+)/$ https://www.hillcopaint.com/$1 [R=301,L]

  # 3b: non-canonical origin + no trailing slash → canonical URL (1 hop)
  RewriteCond %{HTTPS} off [OR]
  RewriteCond %{HTTP_HOST} !^www\.hillcopaint\.com$ [NC]
  RewriteRule ^(.*)$ https://www.hillcopaint.com/$1 [R=301,L]


  ###############################################################################
  # 4) TRAILING SLASH CANONICALIZATION IN ONE HOP (EXCEPT ROOT)
  # Only reaches this rule when origin is already https://www.hillcopaint.com
  # (all non-canonical origins were handled by rule 3a above).
  ###############################################################################
  RewriteCond %{REQUEST_URI} !^/$
  RewriteRule ^(.+)/$ https://www.hillcopaint.com/$1 [R=301,L]


  ###############################################################################
  # 5) SPA FALLBACK — MUST BE LAST
  ###############################################################################
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteCond %{REQUEST_FILENAME} !-d
  RewriteRule . /index.html [L]

</IfModule>

# Security headers
<IfModule mod_headers.c>
  Header set X-Frame-Options "SAMEORIGIN"
  Header set X-Content-Type-Options "nosniff"
  Header set Referrer-Policy "strict-origin-when-cross-origin"
</IfModule>

# Caching
<IfModule mod_expires.c>
  ExpiresActive On
  ExpiresByType text/html "access plus 5 minutes"
  ExpiresByType text/css "access plus 1 year"
  ExpiresByType application/javascript "access plus 1 year"
  ExpiresByType image/jpeg "access plus 1 day"
  ExpiresByType image/png "access plus 1 day"
  ExpiresByType image/webp "access plus 1 day"
  ExpiresByType image/svg+xml "access plus 1 day"
  ExpiresByType application/xml "access plus 1 hour"
  ExpiresByType text/plain "access plus 1 hour"
</IfModule>
